<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' https://cdn.jsdelivr.net https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net data:; img-src 'self' data: https:; connect-src 'self' https:; worker-src 'self'; manifest-src 'self'; object-src 'none'; base-uri 'self'">
<meta name="description" content="Security Checkpoint - Gate Visitor Logging PWA">
<meta name="theme-color" content="#f59e0b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Security Checkpoint</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230a0e17'/%3E%3Ccircle cx='16' cy='11' r='5' fill='none' stroke='%23f59e0b' stroke-width='2'/%3E%3Cpath d='M8 23c0-4.4 3.6-8 8-8s8 3.6 8 8' fill='none' stroke='%23f59e0b' stroke-width='2'/%3E%3C/svg%3E">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<link rel="stylesheet" href="./styles.css">
</head>
<body>

<!-- â•â•â• LOADING â•â•â• -->
<div id="app-loading">
  <div class="spinner"></div>
  <div class="brand">Security Checkpoint</div>
</div>

<!-- â•â•â• LOGIN SCREEN â•â•â• -->
<div id="login-screen" hidden>
  <div class="login-card">
    <div class="logo-icon"><i class="bi bi-shield-lock-fill"></i></div>
    <h1>Security Checkpoint</h1>
    <p class="subtitle" id="login-gate-name">Gate Control System</p>
    <form id="login-form" autocomplete="off">
      <div class="mb-3">
        <label class="form-label">Username</label>
        <input type="text" class="form-control" id="login-user" placeholder="Enter username" required autocomplete="off">
      </div>
      <div class="mb-3">
        <label class="form-label">PIN / Password</label>
        <input type="password" class="form-control" id="login-pass" placeholder="Enter PIN" required autocomplete="off">
      </div>
      <div id="login-error" class="text-danger mb-3 msg-sm d-none"></div>
      <button type="submit" class="btn btn-accent w-100 btn-lg-touch">
        <i class="bi bi-unlock-fill me-2"></i>Authenticate
      </button>
    </form>
  </div>
</div>

<!-- â•â•â• MAIN APP â•â•â• -->
<div id="main-app" hidden>
  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="brand-sm">
      <i class="bi bi-shield-fill-check"></i>
      <span id="topbar-gate-name">Checkpoint</span>
    </div>
    <div class="top-bar-actions">
      <span id="sync-status-badge" class="status-badge status-offline">
        <span class="pulse-dot red"></span>Offline
      </span>
      <button class="btn btn-ghost btn-sm" id="btn-lock" title="Lock Screen">
        <i class="bi bi-lock-fill"></i>
      </button>
    </div>
  </div>

  <!-- â•â•â• DASHBOARD VIEW â•â•â• -->
  <div class="view" id="view-dashboard">
    <div class="row g-2 mb-3">
      <div class="col-6 col-md-3">
        <div class="stat-card stat-accent">
          <div class="stat-value" id="stat-onsite">0</div>
          <div class="stat-label">On Site</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card stat-success">
          <div class="stat-value" id="stat-checkins">0</div>
          <div class="stat-label">Check-ins</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card stat-info">
          <div class="stat-value" id="stat-exits">0</div>
          <div class="stat-label">Exits</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card stat-warning">
          <div class="stat-value" id="stat-avg-time">--</div>
          <div class="stat-label">Avg Time</div>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2 mb-3">
      <button class="btn btn-accent flex-fill btn-lg-touch" id="btn-new-entry">
        <i class="bi bi-person-plus-fill me-1"></i> New Entry
      </button>
      <button class="btn btn-outline-accent" id="btn-export-today" title="Export Today">
        <i class="bi bi-file-earmark-arrow-down"></i>
      </button>
    </div>

    <div class="section-header">
      <span><i class="bi bi-people-fill me-1"></i> Currently On Site</span>
      <span id="onsite-count-label">0</span>
    </div>

    <div id="onsite-list"></div>
  </div>

  <!-- â•â•â• CHECK-IN VIEW â•â•â• -->
  <div class="view" id="view-checkin">
    <div class="section-header">
      <span><i class="bi bi-person-plus-fill me-1"></i> New Entry</span>
    </div>
    <form id="checkin-form" autocomplete="off">
      <div class="mb-3">
        <label class="form-label">Full Name *</label>
        <input type="text" class="form-control" id="ci-name" placeholder="Visitor full name" required autocapitalize="words">
      </div>
      <div class="mb-3">
        <label class="form-label">Cell Number *</label>
        <input type="tel" class="form-control" id="ci-cell" placeholder="e.g. 072 123 4567" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Company *</label>
        <input type="text" class="form-control" id="ci-company" placeholder="Company / Organisation" required autocapitalize="words">
      </div>
      <div class="mb-3">
        <label class="form-label">Vehicle Registration</label>
        <input type="text" class="form-control" id="ci-vehicle" placeholder="e.g. CA 123-456" autocapitalize="characters">
      </div>
      <div class="mb-3">
        <label class="form-label">Notes</label>
        <input type="text" class="form-control" id="ci-notes" placeholder="Optional notes">
      </div>
      <div class="mb-3">
        <label class="form-label">Time In</label>
        <div class="time-display" id="ci-time-in"></div>
      </div>
      <button type="submit" class="btn btn-accent w-100 btn-lg-touch">
        <i class="bi bi-check-circle-fill me-2"></i>Confirm Check-In
      </button>
    </form>
  </div>

  <!-- â•â•â• SEARCH / EXIT VIEW â•â•â• -->
  <div class="view" id="view-exit">
    <div class="section-header">
      <span><i class="bi bi-search me-1"></i> Search & Check-Out</span>
    </div>
    <div class="search-box mb-3">
      <i class="bi bi-search"></i>
      <input type="text" class="form-control" id="exit-search" placeholder="Search name, cell, company, vehicle...">
    </div>
    <div id="exit-search-results"></div>
  </div>

  <!-- â•â•â• LOGS VIEW â•â•â• -->
  <div class="view" id="view-logs">
    <div class="section-header">
      <span><i class="bi bi-clock-history me-1"></i> Visitor Logs</span>
      <button class="btn btn-ghost btn-sm" id="btn-export-logs">
        <i class="bi bi-download me-1"></i>Export
      </button>
    </div>

    <div class="filter-pills" id="log-filters">
      <button class="filter-pill active" data-filter="today">Today</button>
      <button class="filter-pill" data-filter="yesterday">Yesterday</button>
      <button class="filter-pill" data-filter="week">This Week</button>
      <button class="filter-pill" data-filter="custom">Custom</button>
    </div>

    <div id="custom-date-range" class="mb-3 d-none">
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">From</label>
          <input type="date" class="form-control" id="log-date-from">
        </div>
        <div class="col-6">
          <label class="form-label">To</label>
          <input type="date" class="form-control" id="log-date-to">
        </div>
      </div>
    </div>

    <div class="search-box mb-3">
      <i class="bi bi-search"></i>
      <input type="text" class="form-control" id="log-search" placeholder="Search logs...">
    </div>

    <div id="logs-list"></div>
  </div>

  <!-- â•â•â• ADMIN SETTINGS VIEW â•â•â• -->
  <div class="view" id="view-settings">
    <div class="section-header">
      <span><i class="bi bi-gear-fill me-1"></i> Admin Settings</span>
    </div>

    <!-- Branding -->
    <div class="setting-group">
      <div class="setting-group-title"><i class="bi bi-tag-fill me-1"></i> Branding</div>
      <div class="p-3">
        <div class="mb-3">
          <label class="form-label">Site / Gate Name</label>
          <input type="text" class="form-control" id="set-gate-name" placeholder="e.g. Main Gate">
        </div>
        <button class="btn btn-accent btn-sm" id="btn-save-branding">Save Branding</button>
      </div>
    </div>

    <!-- User Management -->
    <div class="setting-group">
      <div class="setting-group-title"><i class="bi bi-people-fill me-1"></i> User Management</div>
      <div class="p-3">
        <div id="user-list" class="mb-3"></div>
        <button class="btn btn-outline-accent btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
          <i class="bi bi-person-plus me-1"></i>Add Guard
        </button>
      </div>
    </div>

    <!-- Online DB Sync -->
    <div class="setting-group">
      <div class="setting-group-title"><i class="bi bi-cloud-arrow-up-fill me-1"></i> Online Database Sync</div>
      <div class="p-3">
        <div class="mb-3">
          <label class="form-label">REST API Endpoint</label>
          <input type="url" class="form-control" id="set-api-url" placeholder="https://example.com/api/method/app.api.visitors.post_visitor">
        </div>
        <div class="mb-3">
          <label class="form-label">API Token</label>
          <input type="password" class="form-control" id="set-api-token" placeholder="token api_key:api_secret">
          <div class="form-text sync-token-note">
            Frappe format: <code class="text-accent">token api_key:api_secret</code>
          </div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-outline-accent btn-sm" id="btn-test-connection">
            <i class="bi bi-plug-fill me-1"></i>Test Connection
          </button>
          <button class="btn btn-accent btn-sm" id="btn-save-sync">Save</button>
        </div>
        <div id="sync-test-result" class="mt-2 msg-sm"></div>
      </div>
    </div>

    <!-- Sync Controls -->
    <div class="setting-group">
      <div class="setting-group-title"><i class="bi bi-arrow-repeat me-1"></i> Sync Controls</div>
      <div class="p-3">
        <div class="d-flex flex-wrap gap-2 mb-3">
          <button class="btn btn-accent btn-sm" id="btn-sync-now">
            <i class="bi bi-arrow-repeat me-1"></i>Sync Now
          </button>
          <button class="btn btn-outline-accent btn-sm" id="btn-retry-failed">
            <i class="bi bi-arrow-clockwise me-1"></i>Retry Failed
          </button>
          <button class="btn btn-ghost btn-sm" id="btn-export-sync-diag">
            <i class="bi bi-bug me-1"></i>Diagnostics
          </button>
        </div>
        <div id="sync-stats" class="small text-secondary"></div>
      </div>
    </div>

    <!-- Data Management -->
    <div class="setting-group">
      <div class="setting-group-title"><i class="bi bi-database-fill me-1"></i> Data Management</div>
      <div class="p-3">
        <div class="mb-3">
          <label class="form-label">Auto-archive after (days)</label>
          <select class="form-select" id="set-retention">
            <option value="30">30 days</option>
            <option value="60">60 days</option>
            <option value="90" selected>90 days</option>
            <option value="180">180 days</option>
            <option value="365">365 days</option>
          </select>
        </div>
        <button class="btn btn-danger-soft btn-sm" id="btn-archive-old">
          <i class="bi bi-archive me-1"></i>Archive Now
        </button>
      </div>
    </div>

    <div class="text-center mt-4 mb-3">
      <small class="text-muted">Security Checkpoint v1.0.0</small><br>
      <small class="text-muted" id="device-id-display"></small>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <button class="nav-item active" data-view="dashboard">
      <i class="bi bi-grid-1x2-fill"></i>
      <span>Dashboard</span>
    </button>
    <button class="nav-item" data-view="exit">
      <i class="bi bi-search"></i>
      <span>Search</span>
    </button>
    <button class="nav-item nav-checkin" data-view="checkin">
      <i class="bi bi-plus-lg"></i>
    </button>
    <button class="nav-item" data-view="logs">
      <i class="bi bi-clock-history"></i>
      <span>Logs</span>
    </button>
    <button class="nav-item" data-view="settings" id="nav-settings">
      <i class="bi bi-gear-fill"></i>
      <span>Settings</span>
    </button>
  </div>
</div>

<!-- â•â•â• MODALS â•â•â• -->

<!-- Confirm Check-In Modal -->
<div class="modal fade" id="confirmCheckinModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>Confirm Check-In</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="confirm-checkin-body"></div>
      <div class="modal-footer">
        <button class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-accent btn-sm" id="btn-confirm-checkin">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Check-Out Modal -->
<div class="modal fade" id="confirmCheckoutModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-box-arrow-right me-2"></i>Confirm Check-Out</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="confirm-checkout-body"></div>
      <div class="modal-footer">
        <button class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger-soft btn-sm" id="btn-confirm-checkout">Mark Exit</button>
      </div>
    </div>
  </div>
</div>

<!-- Visitor Detail Modal -->
<div class="modal fade" id="visitorDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-lines-fill me-2"></i>Visitor Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="visitor-detail-body"></div>
      <div class="modal-footer" id="visitor-detail-footer"></div>
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Add Guard</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Username</label>
        <input type="text" class="form-control" id="new-user-name" placeholder="Guard username" pattern="[a-z0-9._-]{3,24}" maxlength="24" autocomplete="off" autocapitalize="off">
        </div>
        <div class="mb-3">
          <label class="form-label">PIN / Password</label>
          <input type="password" class="form-control" id="new-user-pin" placeholder="Minimum 6 characters" minlength="6" maxlength="32" autocomplete="off">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-accent btn-sm" id="btn-add-user">Create</button>
      </div>
    </div>
  </div>
</div>

<!-- Force PIN Change Modal -->
<div class="modal fade" id="forcePinModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-key-fill me-2"></i>Change Admin PIN</h5>
      </div>
      <div class="modal-body">
        <p class="small text-secondary mb-3">Default admin PIN must be changed before continuing.</p>
        <div class="mb-2">
          <label class="form-label">Current PIN</label>
          <input type="password" class="form-control" id="force-pin-current" autocomplete="off">
        </div>
        <div class="mb-2">
          <label class="form-label">New PIN</label>
          <input type="password" class="form-control" id="force-pin-new" placeholder="Minimum 6 characters" autocomplete="off">
        </div>
        <div class="mb-2">
          <label class="form-label">Confirm New PIN</label>
          <input type="password" class="form-control" id="force-pin-confirm" autocomplete="off">
        </div>
        <div id="force-pin-error" class="text-danger mt-2 msg-sm d-none"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-accent btn-sm" id="btn-force-pin-save">Save PIN</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Time Modal (Admin) -->
<div class="modal fade" id="editTimeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Record</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-record-id">
        <div class="mb-3">
          <label class="form-label">Name</label>
          <input type="text" class="form-control" id="edit-name">
        </div>
        <div class="mb-3">
          <label class="form-label">Cell No</label>
          <input type="text" class="form-control" id="edit-cell">
        </div>
        <div class="mb-3">
          <label class="form-label">Company</label>
          <input type="text" class="form-control" id="edit-company">
        </div>
        <div class="mb-3">
          <label class="form-label">Vehicle Reg</label>
          <input type="text" class="form-control" id="edit-vehicle">
        </div>
        <div class="mb-3">
          <label class="form-label">Time In</label>
          <input type="datetime-local" class="form-control" id="edit-time-in">
        </div>
        <div class="mb-3">
          <label class="form-label">Time Out</label>
          <input type="datetime-local" class="form-control" id="edit-time-out">
        </div>
        <div class="mb-3">
          <label class="form-label">Notes</label>
          <input type="text" class="form-control" id="edit-notes">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-accent btn-sm" id="btn-save-edit">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Export Options Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-file-earmark-arrow-down me-2"></i>Export Logs</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Date Range</label>
          <div class="row g-2">
            <div class="col-6"><input type="date" class="form-control" id="export-from"></div>
            <div class="col-6"><input type="date" class="form-control" id="export-to"></div>
          </div>
        </div>
        <div class="d-grid gap-2">
          <button class="btn btn-accent" id="btn-do-export-xlsx">
            <i class="bi bi-file-earmark-spreadsheet me-2"></i>Export .xlsx
          </button>
          <button class="btn btn-outline-accent" id="btn-do-export-csv">
            <i class="bi bi-filetype-csv me-2"></i>Export .csv
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script src="./vendor/bootstrap.bundle.min.js"></script>
<script src="./vendor/xlsx.full.min.js"></script>
<script src="./app.js"></script>
</body>
</html>


